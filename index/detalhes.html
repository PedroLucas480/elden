<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Build - Elden Builds</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/detalhes.css">
</head>

<body>

    <main class="conteudo-detalhes">
        <div id="build-info">
            <h2 style="color: white; text-align: center;">Carregando detalhes da build...</h2>
        </div>
    </main>

    <script>
        async function carregarDetalhes() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const container = document.getElementById('build-info');

            if (!container || !id) {
                if (container) container.innerHTML = "<h2>Build não identificada.</h2>";
                return;
            }

            try {
                const URL_RAILWAY = "https://elden-production.up.railway.app";
                const apiBaseUrl = window.location.hostname === 'localhost'
                    ? 'http://localhost:3000'
                    : URL_RAILWAY;

                const response = await fetch(`${apiBaseUrl}/api/builds/${id}`);
                if (!response.ok) throw new Error('Build não encontrada');

                const build = await response.json();

                /* ================= LÓGICA DO VÍDEO ================= */
                let videoHtml = "";
                if (build.video_url) {
                    const url = build.video_url.toLowerCase().trim();
                    let urlFinal = build.video_url.trim();

                    if (url.endsWith('.mp4')) {
                        if (!url.startsWith('http') && !url.startsWith('../')) {
                            urlFinal = '../' + urlFinal;
                        }
                        videoHtml = `<video src="${urlFinal}" autoplay muted loop controls playsinline></video>`;
                    }
                    else if (url.includes('tiktok.com')) {
                        const tiktokId = urlFinal.split('/video/')[1]?.split('?')[0];
                        videoHtml = `<iframe src="https://www.tiktok.com/embed/v2/${tiktokId}" frameborder="0" allowfullscreen></iframe>`;
                    }
                    else {
                        let videoId = "";
                        if (url.includes('shorts/')) {
                            videoId = urlFinal.split('shorts/')[1].split(/[?&]/)[0];
                        } else if (url.includes('v=')) {
                            videoId = urlFinal.split('v=')[1].split('&')[0];
                        } else if (url.includes('youtu.be/')) {
                            videoId = urlFinal.split('youtu.be/')[1].split(/[?&]/)[0];
                        }

                        if (videoId) {
                            videoHtml = `<iframe src="https://www.youtube.com/embed/${videoId.trim()}" frameborder="0" allowfullscreen></iframe>`;
                        }
                    }
                }

                if (!videoHtml) {
                    videoHtml = `<div style="padding: 40px; color: #d6b36a; text-align: center;">Vídeo em breve...</div>`;
                }

                /* ================= INJEÇÃO DO HTML FINAL ================= */
                container.innerHTML = `
<div class="build-flex-container">

    <div class="coluna-esquerda">
        <h1>${build.nome || 'Nome da Build'}</h1>
        
        <div class="build-descricao-texto" style="color:#fff; opacity:.9; font-size:1rem; margin-bottom:25px; line-height:1.6;">
            ${build.descricao || 'Sem descrição disponível.'}
        </div>

        <h3 style="color:#e29b00; border-bottom:1px solid rgba(226,155,0,.3); padding-bottom:5px; font-size: 1.1rem; text-transform: uppercase;">
            Estatutos (Stats)
        </h3>

        <div style="line-height: 1.8; margin-top:10px; color: #e29b00; font-weight: bold; font-family: monospace; font-size: 1.1rem;">
            <div>VIGOR: <span style="color:#fff;">${build.vigor || 0}</span></div>
            <div>MENTE: <span style="color:#fff;">${build.mente || 0}</span></div>
            <div>RESISTÊNCIA: <span style="color:#fff;">${build.resistencia || 0}</span></div>
            <div>FORÇA: <span style="color:#fff;">${build.forca || 0}</span></div>
            <div>DESTREZA: <span style="color:#fff;">${build.destreza || 0}</span></div>
            <div>INTELIGÊNCIA: <span style="color:#fff;">${build.inteligencia || 0}</span></div>
            <div>FÉ: <span style="color:#fff;">${build.fe || 0}</span></div>
            <div>ARCANO: <span style="color:#fff;">${build.arcano || 0}</span></div>
        </div>
    </div>

    <div class="coluna-central">
        <div class="build-video">
            ${videoHtml}
        </div>
        <div class="build-mapa">
            ${build.localizacao_url ? 
                `<iframe src="${build.localizacao_url}" frameborder="0" allowfullscreen></iframe>` :
                `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#d6b36a; font-weight:bold;">Mapa em breve...</div>`
            }
        </div>
    </div>

    <div class="coluna-direita">
        <h3 style="color:#e29b00; border-bottom:1px solid rgba(226,155,0,.3); padding-bottom:5px; text-transform: uppercase;">
            Equipamentos
        </h3>
        
        <div style="margin: 15px 0; font-size: 0.95rem; line-height: 1.5; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
            <p><strong>Arma Principal:</strong> <br><span style="color:#fff;">${build.arma_principal || 'Não informada'}</span></p>
            <p><strong>Classe Inicial:</strong> <br><span style="color:#fff;">${build.classe_inicial || 'Desconhecida'}</span></p>
            <p><strong>Localização:</strong> <br><span style="color:#fff;">${build.localizacao_nome || 'Exploração'}</span></p>
        </div>

        <h3 style="color:#e29b00; border-bottom:1px solid rgba(226,155,0,.3); padding-bottom:5px; margin-top:20px; text-transform: uppercase;">
            Vitrine de Itens
        </h3>

<div class="vitrine-itens-grid">
    <div class="item-card-mini">
        <img src="https://eldenring.wiki.fextralife.com/file/Elden-Ring/${(build.arma_principal || 'Greatsword').trim().replace(/ /g, "+")}_Icon.png" 
             alt="${build.arma_principal}" 
             style="width: 80px; height: auto; display: block; margin: 0 auto;">
        <span>${build.arma_principal || 'Arma'}</span>
    </div>

    <div class="item-card-mini">
        <img src="https://eldenring.wiki.fextralife.com/file/Elden-Ring/Shard+of+Alexander_Icon.png" 
             alt="Shard of Alexander" 
             style="width: 80px; height: auto; display: block; margin: 0 auto;">
        <span>Shard of Alexander</span>
    </div>

    <div class="item-card-mini">
        <img src="https://eldenring.wiki.fextralife.com/file/Elden-Ring/Erdtree's+Favor_Icon.png" 
             alt="Erdtree's Favor" 
             style="width: 80px; height: auto; display: block; margin: 0 auto;">
        <span>Erdtree's Favor</span>
    </div>
</div>

        <div style="margin-top:40px; text-align:center;">
            <a href="Builds.html" class="botao-voltar">
                ← VOLTAR PARA BUILDS
            </a>
        </div>
    </div>

</div>
`;
            } catch (error) {
                console.error(error);
                container.innerHTML = `<h2 style="color:#d6b36a; text-align:center; margin-top:50px;">Erro ao carregar: ${error.message}</h2>`;
            }
        }

        window.addEventListener('DOMContentLoaded', carregarDetalhes);
    </script>

</body>
</html>